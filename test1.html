
<!DOCTYPE html>
<html>
 	<head>
		<meta charset='utf-8'>
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.blue-cyan.min.css" />
		<script defer src="https://code.getmdl.io/1.2.1/material.min.js"></script>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://d3js.org/queue.v1.min.js"></script>
		<style>
		rect {
			fill: none;
			stroke: orange;
			stroke-width: 1px;
		}
		</style>
	</head>
	<body>
		<h1 id="title">Lecture des tweets...</h1>
		<script>
			var title = document.getElementById("title");

			var svg = d3.select("body").append("svg")
				.attr("width", 960)
				.attr("height", 250);

			var g = svg.append("g");

			var x = d3.scaleLinear().range([0, 500]);
			var y = d3.scaleLinear().range([0, 30]);

			// Chargement des fichiers de manière asynchrone
			queue()
				.defer(d3.json, "data.json")
				.defer(d3.csv, "emoji.csv")
				.await(processData);  // une fois les fichiers chargé, la fonction processData est appelée avec les fichiers en arguments

 			function processData(error, data, emojis) {
				var tweets = [];

				// Récupération des textes
				for(var t of data.statuses) {
					tweets.push(t.text);
				}
				console.log(tweets.length + " RAW TWEETS : %O", tweets);
				tweets = filterTweets(tweets);

				console.log(emojis.length + " EMOJIS : %O ", emojis);
				console.log(tweets.length + " TWEETS : %O", tweets);

				for(var e of emojis) {
					var n = 0;
					var emoji = e["Brow."];
					for(var tweet of tweets) {
						try {
							var o = tweet.search(emoji);
							if(o != -1) n++;
						} catch(err) {}
					}
					if(n != 0) console.log(emoji + " : " + n);
					// Injecter dans le json les occurences
					e.occurence = n;
				}

				title.innerHTML = "Sur " + tweets.length + " Tweets uniques";
				showStats(emojis);
			}

			function showStats(jsonData) {
				var jsonFiltered = filterEmojis(jsonData);
				var count = jsonFiltered.length;

				svg.attr("height", count * 30);

				x.domain([0, d3.max(jsonFiltered, function(d) { return d.occurence;})]);

				g.selectAll("emojis").data(jsonFiltered).enter().append("text")
					.text(function(d) {
						return d["Brow."];
					})
					.attr("y", function(d, i) { return y(i) + 20; })
					.attr("x", 20)
					.attr("class", "emoji")
					.style("font-size", 20)
					.style("font-family", "monospace");

				g.selectAll("rect").data(jsonFiltered).enter().append("rect")
	    			.attr("x", 50)
	    			.attr("y", function(d, i) { return y(i) + 5; })
	    			.attr("height", 900 / jsonFiltered.length - 10)
					.attr("width", function(d) { return x(d.occurence); })
					.attr("class", "rect")
					.on("mouseover", function(d) {
						d3.select(this).style("fill", "orange");
					})
					.on("mouseout", function(d) {
						d3.select(this).transition().duration(500).style("fill", "white");
					});;

				g.selectAll("occurence").data(jsonFiltered).enter().append("text")
					.text(function(d) {
						return d.occurence;
					})
					.attr("x", function(d) { return x(d.occurence) + 60; })
					.attr("y", function(d, i) { return y(i) + 20; })
					.attr("class", "occurence");
			}

			function filterTweets(data_tweets) {
				var tweets_1 = [];
				//	Suppression des retweets
				for(var i=0 ; i<data_tweets.length ; i++) {
					var tweet = data_tweets[i];
					if(!tweet.startsWith("RT")) {
						tweets_1.push(tweet);
					}
				}

				console.log(tweets_1.length + " EXCEPT RT TWEETS : %O", tweets_1);
				var tweets_2 = []
				//	Suppression des doublons
				for(var i=0 ; i<tweets_1.length ; i++) {
					var found = false;
					var tweet_i = tweets_1[i];
					for(var j=0 ; j<tweets_2.length ; j++) {
						var tweet_j = tweets_2[j];
						if(tweet_i.localeCompare(tweet_j) == 0) {
							found = true;
							break;
						}
					}
					if(!found)
						tweets_2.push(tweet_i)
				}
				return tweets_2;
			}

			function filterEmojis(emojis) {
				var json = [];
				for(var emoji of emojis) {
					if(emoji["occurence"] > 0) {
						json.push(emoji);
					}
				}
				return json;
			}
		</script>
		<h1>Fin SVG</h1>
	</body>
</html>
