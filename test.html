
<!DOCTYPE html>
<html>
 	<head>
		<meta charset='utf-8'>
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.blue-light_blue.min.css" />
		<script defer src="https://code.getmdl.io/1.2.1/material.min.js"></script>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://d3js.org/queue.v1.min.js"></script>
	</head>
	<body>
		<h1 id="title">Lecture des tweets...</h1>
		<script>
			var title = document.getElementById("title");

			var svg = d3.select("body").append("svg")
				.attr("width", 960)
				.attr("height", 250);

			var x = d3.scaleLinear().range([0, 30]);
			var y = d3.scaleLinear().range([0, 30]);

			// Chargement des fichiers de manière asynchrone
			queue()
				.defer(d3.json, "data.json")
				.defer(d3.csv, "emoji.csv")
				.await(processData);  // une fois les fichiers chargé, la fonction processData est appelée avec les fichiers en arguments

 			function processData(error, data, emojis) {
				var tweets = [];

				// Récupération des textes
				for(var t of data.statuses) {
					tweets.push(t.text);
				}
				console.log(tweets.length + " RAW TWEETS : %O", tweets);
				tweets = filterTweets(tweets);

				console.log(emojis.length + " EMOJIS : %O ", emojis);
				console.log(tweets.length + " TWEETS : %O", tweets);

				for(var e of emojis) {
					var n = 0;
					var emoji = e["Brow."];
					for(var tweet of tweets) {
						try {
							var o = tweet.search(emoji);
							if(o != -1) n++;
						} catch(err) {}
					}
					if(n != 0) console.log(emoji + " : " + n);
					// Injecter dans le json les occurences
					e.occurence = n;
				}

				title.innerHTML = "Sur " + tweets.length + " Tweets uniques";
				showStats(emojis);
			}

			function showStats(jsonData) {
				var jsonFiltered = filterEmojis(jsonData);

				svg.selectAll("text").data(jsonFiltered).enter().append("text")
					.text(function(d) {
						return d["Brow."] + " : " + d["occurence"]; })
					.attr("y", function(d, i) {
						var n = i%5;
						return y(i + (n*(-1)))/5 + 40;
					})
					.attr("x", function(d, i) {
						var n = i%5;
						return 10 + (100 * n);
					})
					.style("font-size", 20)
					.style("font-family", "monospace");
			}

			function filterTweets(data_tweets) {
				var tweets_1 = [];
				//	Suppression des retweets
				for(var i=0 ; i<data_tweets.length ; i++) {
					var tweet = data_tweets[i];
					if(!tweet.startsWith("RT")) {
						tweets_1.push(tweet);
					}
				}

				console.log(tweets_1.length + " NO RT TWEETS : %O", tweets_1);
				var tweets_2 = []
				//	Suppression des doublons
				for(var i=0 ; i<tweets_1.length ; i++) {
					var found = false;
					var tweet_i = tweets_1[i];
					for(var j=0 ; j<tweets_2.length ; j++) {
						var tweet_j = tweets_2[j];
						if(tweet_i.localeCompare(tweet_j) == 0) {
							found = true;
							break;
						}
					}
					if(!found)
						tweets_2.push(tweet_i)
				}
				return tweets_2;
			}

			function filterEmojis(emojis) {
				var json = [];
				for(var emoji of emojis) {
					if(emoji["occurence"] > 0) {
						json.push(emoji);
					}
				}
				return json;
			}
		</script>
	</body>
</html>
